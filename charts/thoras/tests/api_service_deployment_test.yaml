suite: API Service Layer Deployment
templates:
  - api-server-v2/deployment.yaml
tests:
  - it: Should use additional securityContext if specified
    set:
      metricsCollector:
        persistence:
          enabled: true
      thorasApiServerV2:
        additionalPvSecurityContext:
          additionalField: "additionalValue"
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0].securityContext
          content:
            runAsUser: 1000
            runAsGroup: 0
            additionalField: "additionalValue"
      - isSubset:
          path: spec.template.spec.initContainers[*].securityContext
          content:
            additionalField: "additionalValue"
  - it: Should not use additional securityContext if not specified
    set:
      metricsCollector:
        persistence:
          enabled: true
    asserts:
      - isSubset:
          path: spec.template.spec.containers[*].securityContext
          content:
            runAsUser: 1000
            runAsGroup: 0
      - notExists:
          path: spec.template.spec.initContainers[*].securityContext
  - it: Should not have any securityContext if persistence is disabled
    asserts:
      - notExists:
          path: spec.template.spec.containers[*].securityContext
  - it: Should tolerations if specified
    set:
      tolerations:
        - key: "example-key"
          operator: "Exists"
          effect: "NoSchedule"
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "example-key"
            operator: "Exists"
            effect: "NoSchedule"
  - it: Should not have tolerations if not specified
    asserts:
      - notExists:
          path: spec.template.spec.tolerations
