suite: Collector
templates:
  - collector/deployment.yaml
  - collector/configmap.yaml
tests:
  - it: Deployment name and images should be correct
    set:
      thorasVersion: TEST
    template: collector/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: metrics-collector
      - equal:
          path: spec.template.spec.containers[?(@.name == 'timescaledb')].image
          value: us-east4-docker.pkg.dev/thoras-registry/platform/timescaledb:2.24.0-pg16
  - it: Default containers should match snapshots
    chart:
      version: "4.50.0"
    set:
      thorasVersion: dev
    template: collector/deployment.yaml
    asserts:
      - matchSnapshot:
          path: spec.template.spec.containers[0]
      - matchSnapshot:
          path: spec.template.spec.containers[?(@.name == 'thoras-blob-api')]
  - it: Should mount pvc when in persistence mode
    set:
      metricsCollector:
        persistence:
          enabled: true
    template: collector/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.volumes
          value:
            - name: elastic-search-data
              persistentVolumeClaim:
                claimName: elastic-search-data
      - equal:
          path: spec.template.spec.containers[?(@.name == 'timescaledb')].volumeMounts
          value:
            - mountPath: /var/lib/share
              name: elastic-search-data
  - it: Should not mount timescale config when config is disabled
    set:
      metricsCollector:
        timescale:
          config:
            enabled: false
    template: collector/deployment.yaml
    asserts:
      - isEmpty:
          path: spec.template.spec.volumes
      - isNull:
          path: spec.template.spec.containers[?(@.name == 'timescaledb')].command
      - isNull:
          path: spec.template.spec.containers[?(@.name == 'timescaledb')].args
  - it: Should mount timescale config when config is enabled
    set:
      metricsCollector:
        timescale:
          config:
            enabled: true
            content: |
              checkpoint_timeout = 15min
    template: collector/deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: timescale-config
            configMap:
              name: thoras-timescale-config
      - equal:
          path: spec.template.spec.containers[?(@.name == 'timescaledb')].command
          value:
            - docker-entrypoint.sh
      - equal:
          path: spec.template.spec.containers[?(@.name == 'timescaledb')].args
          value:
            - "-c"
            - "config_file=/etc/postgresql.conf"
      - contains:
          path: spec.template.spec.containers[?(@.name == 'timescaledb')].volumeMounts
          content:
            name: timescale-config
            mountPath: /etc/postgresql.conf
            subPath: custom.conf
  - it: Should always create timescale container
    template: collector/deployment.yaml
    asserts:
      - contains:
          path: $..spec.containers
          content:
            name: timescaledb
          any: true

  ### Security context tests
  - it: Should use additional securityContext if specified
    set:
      metricsCollector:
        persistence:
          enabled: true
        additionalPvSecurityContext:
          additionalField: "additionalValue"
    template: collector/deployment.yaml
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0,1].securityContext
          content:
            runAsUser: 1000
            runAsGroup: 0
            additionalField: "additionalValue"
      - isSubset:
          path: spec.template.spec.initContainers[0,1].securityContext
          content:
            additionalField: "additionalValue"
  - it: Should not use additional securityContext if not specified
    set:
      metricsCollector:
        persistence:
          enabled: true
    template: collector/deployment.yaml
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0,1].securityContext
          content:
            runAsUser: 1000
            runAsGroup: 0
      - notExists:
          path: spec.template.spec.initContainers[*].securityContext
  - it: Should not have any securityContext if persistence is disabled
    template: collector/deployment.yaml
    asserts:
      - notExists:
          path: spec.template.spec.containers[*].securityContext
  - it: Should set tolerations if specified
    set:
      tolerations:
        - key: "example-key"
          operator: "Exists"
          effect: "NoSchedule"
    template: collector/deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "example-key"
            operator: "Exists"
            effect: "NoSchedule"
  - it: Should not have tolerations if not specified
    template: collector/deployment.yaml
    asserts:
      - notExists:
          path: spec.template.spec.tolerations
  - it: Should not have annotations section when podAnnotations are not set
    set:
      metricsCollector:
        podAnnotations: {}
    template: collector/deployment.yaml
    asserts:
      - notExists:
          path: spec.template.metadata.annotations
  - it: Should have annotations section when podAnnotations are set
    set:
      metricsCollector:
        podAnnotations:
          custom-annotation: "test-value"
    template: collector/deployment.yaml
    asserts:
      - exists:
          path: spec.template.metadata.annotations
      - equal:
          path: spec.template.metadata.annotations["custom-annotation"]
          value: "test-value"
  - it: Should enable request and limit overrides
    template: collector/deployment.yaml
    set:
      metricsCollector:
        timescale:
          requests:
            memory: "512Mi"
            cpu: "500m"
            hugepages-1Gi: 2Gi
          limits:
            memory: "1Gi"
            cpu: "1"
            hugepages-1Gi: 2Gi
    asserts:
      - isSubset:
          path: spec.template.spec.containers[?(@.name == 'timescaledb')].resources
          content:
            requests:
              memory: "512Mi"
              cpu: "500m"
              hugepages-1Gi: "2Gi"
            limits:
              memory: "1Gi"
              cpu: "1"
              hugepages-1Gi: "2Gi"
  - it: Can override resources block
    template: collector/deployment.yaml
    set:
      metricsCollector:
        timescale:
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
              hugepages-1Gi: "2Gi"
            limits:
              memory: "1Gi"
              cpu: "1"
              hugepages-1Gi: "2Gi"
    chart:
      version: "4.7.0"
    asserts:
      - isSubset:
          path: spec.template.spec.containers[?(@.name == 'timescaledb')].resources
          content:
            requests:
              memory: "512Mi"
              cpu: "500m"
              hugepages-1Gi: "2Gi"
            limits:
              memory: "1Gi"
              cpu: "1"
              hugepages-1Gi: "2Gi"
