suite: Image Pull Secrets
templates:
  - "*/deployment.yaml"
  - "agent/daemonset.yaml"
set:
  # Enable all optional deployments
  thorasForecast:
    worker:
      enabled: true
  thorasMonitor:
    enabled: true
    unittesting: true
  thorasDashboard:
    unittesting: true
  thorasSlmAgent:
    enabled: true
  thorasAgent:
    enabled: true
tests:
  - it: Should have imagePullSecrets when imagePullSecretInDeployment is true and secretRef is set
    set:
      imageCredentials:
        imagePullSecretInDeployment: true
        secretRef: "my-registry-secret"
    asserts:
      - exists:
          path: spec.template.spec.imagePullSecrets
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: "my-registry-secret"

  - it: Should NOT have imagePullSecrets when imagePullSecretInDeployment is false
    set:
      imageCredentials:
        imagePullSecretInDeployment: false
        secretRef: "my-registry-secret"
    asserts:
      - notExists:
          path: spec.template.spec.imagePullSecrets

  - it: Should NOT have imagePullSecrets when secretRef is empty
    set:
      imageCredentials:
        imagePullSecretInDeployment: true
        secretRef: ""
    asserts:
      - notExists:
          path: spec.template.spec.imagePullSecrets

  - it: Should NOT have imagePullSecrets when both flags are false
    set:
      imageCredentials:
        imagePullSecretInDeployment: false
        secretRef: ""
    asserts:
      - notExists:
          path: spec.template.spec.imagePullSecrets

  - it: Should have imagePullSecrets with correct name when using custom secretRef
    set:
      imageCredentials:
        imagePullSecretInDeployment: true
        secretRef: "custom-docker-secret"
    asserts:
      - exists:
          path: spec.template.spec.imagePullSecrets
      - lengthEqual:
          path: spec.template.spec.imagePullSecrets
          count: 1
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: "custom-docker-secret"
