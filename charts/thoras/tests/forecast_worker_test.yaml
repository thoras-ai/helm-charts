suite: Forecast Worker
templates:
  - forecast-worker/deployment.yaml
set:
  thorasForecast:
    imageTag: "TEST"
    worker:
      enabled: true
tests:
  - it: Ensure forecast worker settings
    set:
      thorasForecast:
        worker:
          replicas: 10
          pollingInterval: 30
          limits:
            memory: 2.5Gi
            cpu: 4
          requests:
            cpu: 1500m
            memory: 100Mi
          forecastTimeout: 600
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: thoras-forecast-worker
      - equal:
          path: spec.template.spec.containers[0].image
          value: us-east4-docker.pkg.dev/thoras-registry/platform/thoras-forecast:TEST
      - equal:
          path: spec.replicas
          value: 10
      - equal:
          path: spec.template.spec.containers[0].resources.requests
          value:
            cpu: 1500m
            memory: 100Mi
      - equal:
          path: spec.template.spec.containers[0].resources.limits
          value:
            memory: 2.5Gi
            cpu: 4
      - equal:
          path: spec.template.spec.containers[0].command
          value:
            - "worker"
            - "--polling_interval"
            - "30"
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: "LOGLEVEL"
              value: info
            - name: API_BASE_URL
              value: "http://thoras-api-server-v2"
            - name: FORECAST_TIMEOUT
              value: "600"
            - name: OMP_NUM_THREADS
              value: "1"
            - name: FORECAST_IGNORE_NEW_PODS
              value: "false"
            - name: SERVICE_ENABLE_FORECAST_AFFINITY
              value: "false"
            - name: MAX_TIMESERIES_METRIC_CACHE_SIZE_MB
              value: "1000"

  - it: sets RETRAIN_STEADY_STATE_HOURS when value is an integer
    set:
      thorasForecast:
        worker:
          retrainSteadyStateHours: 10
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: RETRAIN_STEADY_STATE_HOURS
            value: "10"

  - it: sets RETRAIN_STEADY_STATE_HOURS when value is a float
    set:
      thorasForecast:
        worker:
          retrainSteadyStateHours: 10.0
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: RETRAIN_STEADY_STATE_HOURS
            value: "10"

  - it: omits RETRAIN_STEADY_STATE_HOURS when value is null
    set:
      thorasForecast:
        worker:
          retrainSteadyStateHours: null
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: RETRAIN_STEADY_STATE_HOURS

  - it: omits RETRAIN_STEADY_STATE_HOURS when value is empty string
    set:
      thorasForecast:
        worker:
          retrainSteadyStateHours: ""
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: RETRAIN_STEADY_STATE_HOURS

  - it: clamps RETRAIN_STEADY_STATE_HOURS to 1.0 when below minimum
    set:
      thorasForecast:
        worker:
          retrainSteadyStateHours: 0.1
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: RETRAIN_STEADY_STATE_HOURS
            value: "1"

  - it: sets RETRAIN_OVERRIDE_HOURS when value is an integer
    set:
      thorasForecast:
        worker:
          retrainOverrideHours: 10
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: RETRAIN_OVERRIDE_HOURS
            value: "10"

  - it: sets RETRAIN_OVERRIDE_HOURS when value is a float
    set:
      thorasForecast:
        worker:
          retrainOverrideHours: 10.0
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: RETRAIN_OVERRIDE_HOURS
            value: "10"

  - it: omits RETRAIN_OVERRIDE_HOURS when value is null
    set:
      thorasForecast:
        worker:
          retrainOverrideHours: null
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: RETRAIN_OVERRIDE_HOURS

  - it: omits RETRAIN_OVERRIDE_HOURS when value is empty string
    set:
      thorasForecast:
        worker:
          retrainOverrideHours: ""
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: RETRAIN_OVERRIDE_HOURS

  - it: does not clamp RETRAIN_OVERRIDE_HOURS when below 1.0
    set:
      thorasForecast:
        worker:
          retrainOverrideHours: 0.1
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: RETRAIN_OVERRIDE_HOURS
            value: "0.1"

  - it: renders FORECAST_IGNORE_NEW_PODS as false by default
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: FORECAST_IGNORE_NEW_PODS
            value: "false"

  - it: renders FORECAST_IGNORE_NEW_PODS as true when ignoreNewPods is true
    set:
      thorasForecast:
        ignoreNewPods: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: FORECAST_IGNORE_NEW_PODS
            value: "true"

  - it: renders MAX_TIMESERIES_METRIC_CACHE_SIZE_MB with default value
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MAX_TIMESERIES_METRIC_CACHE_SIZE_MB
            value: "1000"

  - it: renders MAX_TIMESERIES_METRIC_CACHE_SIZE_MB with custom value
    set:
      thorasForecast:
        worker:
          maxTimeseriesMetricCacheSizeMb: 2500
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MAX_TIMESERIES_METRIC_CACHE_SIZE_MB
            value: "2500"
