suite: Operator
templates:
  - operator/deployment.yaml
tests:
  - it: Ensure MODEL_SKIP_CACHE not exists when reasoning is enabled
    set:
      thorasForecast:
        skipCache: true
    asserts:
      - equal:
          path: $.spec.template.spec.containers[0].env[?(@.name == 'MODEL_SKIP_CACHE')].value
          value: "true"
  - it: Has FORECAST_NODE_SELECTOR set when nodeSelector specified
    set:
      nodeSelector:
        color: green
        bestGame: sekiro
    asserts:
      - equal:
          path: .spec.template.spec.containers[0].env[?(@.name == 'FORECAST_NODE_SELECTOR')].value
          value: "bestGame:sekiro,color:green"
  ############################
  # Resource allocation
  ############################

  - it: Should not have annotations section when all conditions are false
    set:
      thorasOperator:
        prometheus:
          enabled: false
        podAnnotations: {}
    asserts:
      - notExists:
          path: spec.template.metadata.annotations
  - it: Should have annotations section when prometheus is enabled
    set:
      thorasOperator:
        prometheus:
          enabled: true
          port: 8080
    asserts:
      - exists:
          path: spec.template.metadata.annotations
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"
  - it: Should have annotations section when podAnnotations are set
    set:
      thorasOperator:
        prometheus:
          enabled: false
        podAnnotations:
          custom-annotation: "test-value"
    asserts:
      - exists:
          path: spec.template.metadata.annotations
      - equal:
          path: spec.template.metadata.annotations["custom-annotation"]
          value: "test-value"
  - it: Should enable request and limit overrides
    set:
      thorasOperator:
        requests:
          memory: "512Mi"
          cpu: "500m"
          hugepages-1Gi: 2Gi
        limits:
          memory: "1Gi"
          cpu: "1"
          hugepages-1Gi: 2Gi
    asserts:
      - isSubset:
          path: spec.template.spec.containers[?(@.name == 'thoras-operator')].resources
          content:
            requests:
              memory: "512Mi"
              cpu: "500m"
              hugepages-1Gi: "2Gi"
            limits:
              memory: "1Gi"
              cpu: "1"
              hugepages-1Gi: "2Gi"
  - it: Can override resources block
    set:
      thorasOperator:
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
            hugepages-1Gi: "2Gi"
          limits:
            memory: "1Gi"
            cpu: "1"
            hugepages-1Gi: "2Gi"
    chart:
      version: "4.7.0"
    asserts:
      - isSubset:
          path: spec.template.spec.containers[?(@.name == 'thoras-operator')].resources
          content:
            requests:
              memory: "512Mi"
              cpu: "500m"
              hugepages-1Gi: "2Gi"
            limits:
              memory: "1Gi"
              cpu: "1"
              hugepages-1Gi: "2Gi"
