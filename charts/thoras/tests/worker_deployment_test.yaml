suite: Worker Deployment
templates:
  - worker/deployment.yaml
set:
  thorasMonitor:
    unittesting: true
tests:
  - it: Should set tolerations if specified
    set:
      tolerations:
        - key: "example-key"
          operator: "Exists"
          effect: "NoSchedule"
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "example-key"
            operator: "Exists"
            effect: "NoSchedule"
  - it: Should not have tolerations if not specified
    asserts:
      - notExists:
          path: spec.template.spec.tolerations
  - it: Should not have annotations section when all conditions are false
    set:
      thorasWorker:
        prometheus:
          enabled: false
        podAnnotations: {}
    asserts:
      - notExists:
          path: spec.template.metadata.annotations
  - it: Should have annotations section when prometheus is enabled
    set:
      thorasWorker:
        prometheus:
          enabled: true
          port: 8080
    asserts:
      - exists:
          path: spec.template.metadata.annotations
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"
  - it: Should have annotations section when podAnnotations are set
    set:
      thorasWorker:
        prometheus:
          enabled: false
        podAnnotations:
          custom-annotation: "test-value"
    asserts:
      - exists:
          path: spec.template.metadata.annotations
      - equal:
          path: spec.template.metadata.annotations["custom-annotation"]
          value: "test-value"
  - it: Should ensure default extensionVersion is substring of default imageTag
    set:
      metricsCollector:
        timescale:
          extensionVersion: "2.24.0"
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].env[?(@.name == 'EXTENSION_VERSION')].value
          value: "2.24.0"
  - it: Cloud sync is disabled by default
    asserts:
      - equal:
          path: $.spec.template.spec.containers[0].env[?(@.name == 'SERVICE_ENABLE_CLOUD_SYNC_WORKER')].value
          value: "false"
  - it: Cloud sync on when configured properly
    set:
      cloudSync:
        clusterKeyID: "my-cluster-key-id"
      thorasWorker:
        cloudSyncBaseUrl: "https://console.thoras.ai"
    asserts:
      - equal:
          path: $.spec.template.spec.containers[0].env[?(@.name == 'SERVICE_ENABLE_CLOUD_SYNC_WORKER')].value
          value: "true"
      - equal:
          path: $.spec.template.spec.containers[0].env[?(@.name == 'SERVICE_CLOUD_SYNC_CLUSTER_KEY_ID')].value
          value: "my-cluster-key-id"
      - equal:
          path: $.spec.template.spec.containers[0].env[?(@.name == 'SERVICE_CLOUD_SYNC_BASE_URL')].value
          value: "https://console.thoras.ai"
