suite: WorkerSecrets
tests:
  - it: Points all apps to existing cluster key secret, if provided
    templates:
      - worker/deployment.yaml
    set:
      cloudSync.clusterKeySecretRefName: "frou-frou"
      cloudSync.clusterKeySecretRefKey: "url"
    asserts:
      - equal:
          path: $..spec.containers[?(@.name == 'thoras-worker')].env[?(@.name == 'SERVICE_CLOUD_SYNC_CLUSTER_KEY')].valueFrom.secretKeyRef.name
          value: "frou-frou"
      - equal:
          path: $..spec.containers[?(@.name == 'thoras-worker')].env[?(@.name == 'SERVICE_CLOUD_SYNC_CLUSTER_KEY')].valueFrom.secretKeyRef.key
          value: "url"

  - it: Points all apps to default cluster key secret, if no existing secret provided
    templates:
      - worker/deployment.yaml
    asserts:
      - equal:
          path: $..spec.containers[?(@.name == 'thoras-worker')].env[?(@.name == 'SERVICE_CLOUD_SYNC_CLUSTER_KEY')].valueFrom.secretKeyRef.name
          value: "thoras-cloud-sync"
      - equal:
          path: $..spec.containers[?(@.name == 'thoras-worker')].env[?(@.name == 'SERVICE_CLOUD_SYNC_CLUSTER_KEY')].valueFrom.secretKeyRef.key
          value: "clusterKey"
